<!DOCTYPE html>
<html class="" lang="en-us"><head>
    
    <meta name="viewport" content="width=device-width" />
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=7" />

    <link
    rel="icon"
    href='/favicon.png'
/>
<link
    rel="shortcut icon"
    href='/favicon.ico'
    type="image/x-icon"
/>
<link
    rel="apple-touch-icon"
    href='/apple-touch-icon.png'
/>

    <link
        rel="icon"
        href='/logo.svg'
        type="image/svg+xml"
    />

<title>
        
            Một vài cách sử dụng channel trong golang  &ndash;
        
        Dev&#39;s Log
    </title>
    <link href="/symbols-nerd-font/symbols-nerd-font.css" rel="stylesheet" />
    <link href="/jetbrains-mono/jetbrains-mono.css" rel="stylesheet" />
    
    
    <link type="text/css" rel="stylesheet" href=https://idev-blog.web.app/css/styles.9b53275cb4d8eaa20bdbb49c202ffdc504a19d2a26a8724d44e3ab30e790bf408f9945c440b56636adeb6aac088b0ce94240f32a3e22b4dd1c55f8bb05663c0a.css integrity="sha512-m1MnXLTY6qIL27ScIC/9xQShnSomqHJNROOrMOeQv0CPmUXEQLVmNq3raqwIiwzpQkDzKj4itN0cVfi7BWY8Cg==" />
<meta name="author" content="" />

    
        <meta name="keywords" content='channel, concurrency, golang' />
    
    
        <meta name="description" content="ộ (asynchronous) và đồng thời (concurrency) trở lên dễ dàng với channel trong Golang. Synchronization với channel có phạm vi sử dụng lớn và nhiều biến thể hơn so với các mô hình khác như actoc model hay async/await pattern." />
    

<meta property="og:site_name"
    content='Dev&#39;s Log' />

    <meta property="og:title" content="Một vài cách sử dụng channel trong golang" />
    <meta property="og:type" content="article" />
    
    <meta
        property="article:author" content="" />
    <meta
        property="article:published_time"
        content='2023-03-03T00:00:00Z&#43;0000' />
    
        
            <meta property="article:tag" content="channel" />
        
            <meta property="article:tag" content="concurrency" />
        
            <meta property="article:tag" content="golang" />
        
    
    <meta property="og:url" content="https://idev-blog.web.app/posts/golang-channel-usecase/" />
    
    
    <meta property="og:image"
        content="https://idev-blog.web.app/android-chrome-512x512.png" />
    
        <meta property="og:description" content="Lập trình bất đồng bộ (asynchronous) và đồng thời (concurrency) trở lên dễ dàng với channel trong Golang. Synchronization với channel có phạm vi sử dụng lớn và " />
    

<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:domain"
      content='idev-blog.web.a'
/>
<meta property="twitter:url" content="https://idev-blog.web.app/posts/golang-channel-usecase/" />


    <meta name="twitter:title" content="Một vài cách sử dụng channel trong golang" />
    
    
    
    <meta name="twitter:image"
        content="https://idev-blog.web.app/android-chrome-512x512.png" />
    
        <meta name="twitter:description" content="Lập trình bất đồng bộ (asynchronous) và đồng thời (concurrency) trở lên dễ dàng với channel trong Golang. Synchronization với channel có phạm vi sử dụng lớn và " />
    

<link rel="manifest" href="/manifest/index.json" />
</head>


<body>
        <div id="baseContainer"><header class="">
<div class="titleAndSearchContainer">
        <div id="titleContainer">
            
                <a class="unstyledLink" href="/">
                    <img src='/logo.png' alt='Logo'/>
                </a>
            
            <div class="rightOfLogo">
                <div class="titleAndHamburger">
                    <h1>
                        <a class="unstyledLink" href="/">Dev&#39;s Log</a>
                        
                    </h1>
                    
                </div>
                <div id="wide_nav"><nav>
    
    <ul id="main-nav">
        <li><a href="/">Home</a></li>
        
            <li><a href="/posts">Posts</a></li>
        
        
        
        
        
        
        
            <li><a href="/authors">Authors</a></li>
        
        
            <li><a href="/series">Series</a></li>
        
        
            <li><a href="/tags">Tags</a></li>
        
        
    </ul>
</nav>
</div>
            </div>
        </div>
        <div class="search">
    <input id="searchbar" type="text" placeholder='Search' />
    <a class="nerdlink" onclick="newSearch();">&#xf002;</a>
</div>
<script>
    function newSearch() {
        let term = searchbar.value.trim();
        if (!term) return;
        location.href = `/search?q=${term}`;
    }
    searchbar.onkeyup = (ev) => {if (ev.keyCode == 13) newSearch()};
</script>

    </div>
    <div id="links">
        <a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="/index.xml">
    
    
        &#xf09e;
    
    <span>
        RSS
    </span>
</a>

        
        <a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="https://www.facebook.com/ngoctd314">
    
    
        &#xf09a;
    
    <span>
        Facebook
    </span>
</a>
<a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="https://github.com/ngoctd314">
    
    
        &#xf09b;
    
    <span>
        GitHub
    </span>
</a>
<a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="https://github.com/ngoctd314">
    
    
        &#xf0e1;
    
    <span>
        Email
    </span>
</a>

    </div>
    
        <div id="sidebar_nav"><nav>
    
    <ul id="main-nav">
        <li><a href="/">Home</a></li>
        
            <li><a href="/posts">Posts</a></li>
        
        
        
        
        
        
        
            <li><a href="/authors">Authors</a></li>
        
        
            <li><a href="/series">Series</a></li>
        
        
            <li><a href="/tags">Tags</a></li>
        
        
    </ul>
</nav>
</div>
        
    

</header>
<div id="contentContainer">
                <div id="content">
                    <main>
<article class="card single">
    
        <h1>Một vài cách sử dụng channel trong golang</h1>
    


    
        <p class="date">
            <span title='Date'> </span>
    2023-03-03


                <span>/ authors </span>
                
                
                    <a
                        
                        href="/authors/ngoctd">#ngoctd</a>
                
            
            
                <span>/ tags </span>
                
                    <a
                        
                        href="/tags/channel">#channel</a>
                
                    <a
                        
                        href="/tags/concurrency">#concurrency</a>
                
                    <a
                        
                        href="/tags/golang">#golang</a>
                
            
        </p>
    
    
    
    
    <div><p>Lập trình bất đồng bộ (asynchronous) và đồng thời (concurrency) trở  lên dễ dàng với channel trong Golang. Synchronization với channel có phạm vi sử dụng lớn và nhiều biến thể hơn so với các mô hình khác như actoc model hay async/await pattern.</p>
<p>Trong bài này mình sẽ tổng hợp lại các trường hợp sử dụng channel trong golang, mục đích chính là sử dụng nhiều nhất có thể (chứ không phải là trường hợp tốt nhất) có thể các kĩ thuật khác về synchronization sẽ tốt hơn.</p>
<h2 id="sử-dụng-channel-như-futurespromises">Sử dụng channel như Futures/Promises</h2>
<p>Future và promises được sử dụng trong nhiều ngôn ngữ khác nhau. Chúng thường được sử dụng dưới dạng requests và responses.</p>
<p><strong>Lười làm thì thuê - Return receive-only channel</strong></p>
<p>Trong ví dụ dưới longTimeRequest xử lý async bằng cách trả về receive-only channel. Mỗi hàm longTimeRequest thực hiện hết 1s (sleep). Bằng cách đưa phần sleep (minh họa cho workload nào đó) chạy dưới goroutine và trả về ngay receive-only channel thì giúp x2 thời gian thực hiện.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
</span></span><span style="display:flex;"><span>	now <span style="color:#ff79c6">:=</span> time.<span style="color:#50fa7b">Now</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// do async
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	r1, r2 <span style="color:#ff79c6">:=</span> <span style="color:#50fa7b">longTimeRequest</span>(), <span style="color:#50fa7b">longTimeRequest</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">getResponse</span>(r1)
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">getResponse</span>(r2)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	log.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;since: &#34;</span>, time.<span style="color:#50fa7b">Since</span>(now))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">longTimeRequest</span>() <span style="color:#ff79c6">&lt;-</span><span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">string</span> {
</span></span><span style="display:flex;"><span>	ch <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>(<span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">string</span>)
</span></span><span style="display:flex;"><span>	now <span style="color:#ff79c6">:=</span> time.<span style="color:#50fa7b">Now</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// async here
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
</span></span><span style="display:flex;"><span>		time.<span style="color:#50fa7b">Sleep</span>(time.Second)
</span></span><span style="display:flex;"><span>		ch <span style="color:#ff79c6">&lt;-</span> fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;long time request response after: %v&#34;</span>, time.<span style="color:#50fa7b">Since</span>(now))
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">close</span>(ch)
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> ch
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">getResponse</span>(ch <span style="color:#ff79c6">&lt;-</span><span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">string</span>) {
</span></span><span style="display:flex;"><span>	log.<span style="color:#50fa7b">Println</span>(<span style="color:#ff79c6">&lt;-</span>ch)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>Lười làm thì thuê - Pass send-only channels</strong></p>
<p>Thay vì trả về receive-only channel, ta có thể sử dụng send-only channels như là một phương pháp thay thế. Tuy nhiên mình thấy cách receive-only channel sử dụng clean hơn.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
</span></span><span style="display:flex;"><span>	now <span style="color:#ff79c6">:=</span> time.<span style="color:#50fa7b">Now</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// sử dụng buffered channel để tránh block khi gửi
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	ch <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>(<span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">string</span>, <span style="color:#bd93f9">2</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">go</span> <span style="color:#50fa7b">longTimeRequest</span>(ch)
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">go</span> <span style="color:#50fa7b">longTimeRequest</span>(ch)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">getResponse</span>(ch)
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">getResponse</span>(ch)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	log.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;since: &#34;</span>, time.<span style="color:#50fa7b">Since</span>(now))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">longTimeRequest</span>(ch <span style="color:#8be9fd;font-style:italic">chan</span><span style="color:#ff79c6">&lt;-</span> <span style="color:#8be9fd">string</span>) {
</span></span><span style="display:flex;"><span>	now <span style="color:#ff79c6">:=</span> time.<span style="color:#50fa7b">Now</span>()
</span></span><span style="display:flex;"><span>	time.<span style="color:#50fa7b">Sleep</span>(time.Second)
</span></span><span style="display:flex;"><span>	ch <span style="color:#ff79c6">&lt;-</span> fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;long time request response after: %v&#34;</span>, time.<span style="color:#50fa7b">Since</span>(now))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">getResponse</span>(ch <span style="color:#ff79c6">&lt;-</span><span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">string</span>) {
</span></span><span style="display:flex;"><span>	log.<span style="color:#50fa7b">Println</span>(<span style="color:#ff79c6">&lt;-</span>ch)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>Ai nhanh thì thắng - The first response win</strong></p>
<p>Một ngày đẹp trời, cà rốt của bạn đăng story: tối nay tớ rảnh? Bạn suy nghĩ hết nửa tiếng đồng hồ rồi reply để hẹn địa điểm, thì nhận được câu trả lời là tớ set kèo đi với người khác rồi. Thực ra là dù có reply sớm thì cà rốt cũng chả đi với bạn đâu :v tuy nhiên bạn đến muộn thì người ta có cái cớ rất chi là hợp lí để từ chối. Không lan man nữa, vào việc thôi.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
</span></span><span style="display:flex;"><span>	now <span style="color:#ff79c6">:=</span> time.<span style="color:#50fa7b">Now</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	queue <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">10</span>
</span></span><span style="display:flex;"><span>	ok <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>(<span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">int</span>, queue)
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; i &lt; queue; i<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">go</span> <span style="color:#50fa7b">reply</span>(ok, i)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// ai nhanh thì thắng
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	firstRepsonse <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&lt;-</span>ok
</span></span><span style="display:flex;"><span>	log.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;since: &#34;</span>, time.<span style="color:#50fa7b">Since</span>(now), <span style="color:#f1fa8c">&#34;pos&#34;</span>, firstRepsonse)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">init</span>() {
</span></span><span style="display:flex;"><span>	rand.<span style="color:#50fa7b">Seed</span>(time.<span style="color:#50fa7b">Now</span>().<span style="color:#50fa7b">Unix</span>())
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">reply</span>(ch <span style="color:#8be9fd;font-style:italic">chan</span><span style="color:#ff79c6">&lt;-</span> <span style="color:#8be9fd">int</span>, pos <span style="color:#8be9fd">int</span>) {
</span></span><span style="display:flex;"><span>	rd <span style="color:#ff79c6">:=</span> rand.<span style="color:#50fa7b">Intn</span>(<span style="color:#bd93f9">3</span>) <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>	time.<span style="color:#50fa7b">Sleep</span>(time.<span style="color:#50fa7b">Duration</span>(rd) <span style="color:#ff79c6">*</span> time.Second)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	ch <span style="color:#ff79c6">&lt;-</span> pos
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Chú ý là phải dùng buffered channel để tránh ăn send block của channel nhé (goroutine leak problem). Đoạn code trên còn vấn đề là chẳng hạn cà rốt chỉ đăng tin cho người nào đó xem thôi, người đó reply rồi thì cà rốt thêm một tin mới là đã tìm được người cần tìm rồi. Thế là bạn cũng không cần reply lại nữa. Vậy xử lý thế nào nhỉ?</p>
<p>Câu trả lời là dùng context</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
</span></span><span style="display:flex;"><span>	now <span style="color:#ff79c6">:=</span> time.<span style="color:#50fa7b">Now</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	queue <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">10</span>
</span></span><span style="display:flex;"><span>	ok <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>(<span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">int</span>, queue)
</span></span><span style="display:flex;"><span>	ctx, cancel <span style="color:#ff79c6">:=</span> context.<span style="color:#50fa7b">WithCancel</span>(context.<span style="color:#50fa7b">Background</span>())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; i &lt; queue; i<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">go</span> <span style="color:#50fa7b">reply</span>(ctx, ok, i)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// ai nhanh thì thắng
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	firstRepsonse <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&lt;-</span>ok
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">cancel</span>()
</span></span><span style="display:flex;"><span>	log.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;since: &#34;</span>, time.<span style="color:#50fa7b">Since</span>(now), <span style="color:#f1fa8c">&#34;pos&#34;</span>, firstRepsonse)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">init</span>() {
</span></span><span style="display:flex;"><span>	rand.<span style="color:#50fa7b">Seed</span>(time.<span style="color:#50fa7b">Now</span>().<span style="color:#50fa7b">Unix</span>())
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">reply</span>(ctx context.Context, ch <span style="color:#8be9fd;font-style:italic">chan</span><span style="color:#ff79c6">&lt;-</span> <span style="color:#8be9fd">int</span>, pos <span style="color:#8be9fd">int</span>) {
</span></span><span style="display:flex;"><span>	rd <span style="color:#ff79c6">:=</span> rand.<span style="color:#50fa7b">Intn</span>(<span style="color:#bd93f9">3</span>) <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">select</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">case</span> <span style="color:#ff79c6">&lt;-</span>time.<span style="color:#50fa7b">After</span>(time.<span style="color:#50fa7b">Duration</span>(rd) <span style="color:#ff79c6">*</span> time.Second):
</span></span><span style="display:flex;"><span>		log.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;run&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">case</span> <span style="color:#ff79c6">&lt;-</span>ctx.<span style="color:#50fa7b">Done</span>():
</span></span><span style="display:flex;"><span>		log.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;cancel&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	ch <span style="color:#ff79c6">&lt;-</span> pos
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="sử-dụng-channel-để-notification">Sử dụng channel để notification</h2>
<p><strong>Đừng kể với ai nhé - 1-to-1 notification</strong></p>
<p>Một ngày đẹp trời, bạn được đi chơi riêng với cà rốt, có những điều từ lâu bạn đã muốn nói riêng với cô ấy. Hôm nay bạn mới có cơ hội vậy thì thắt dây an toàn và vào việc thôi.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
</span></span><span style="display:flex;"><span>	ch <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>(<span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">string</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">go</span> <span style="color:#50fa7b">secret</span>(ch)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	log.<span style="color:#50fa7b">Println</span>(<span style="color:#ff79c6">&lt;-</span>ch)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">secret</span>(ch <span style="color:#8be9fd;font-style:italic">chan</span><span style="color:#ff79c6">&lt;-</span> <span style="color:#8be9fd">string</span>) {
</span></span><span style="display:flex;"><span>	time.<span style="color:#50fa7b">Sleep</span>(time.Second)
</span></span><span style="display:flex;"><span>	ch <span style="color:#ff79c6">&lt;-</span> <span style="color:#f1fa8c">&#34;this is secret&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>Gửi đám bạn thân - 1-to-n notification</strong></p>
<p>Bên trên bạn chỉ thổ lộ riêng với cà rốt, bạn nghĩ điều đó là bí mật riêng của hai người, nhưng mà biết đâu được, bạn đâu kiểm soát được nó. Bí mật chỉ là bí mật khi chỉ có một người biết thôi. Ví dụ cô ấy gửi tấm chân tình của bạn đến đám bạn thân chẳng hạn :v.</p>
<p>Có nhiều cách để thực hiện 1-to-n notification. Cách đơn giản nhất là close channel. Do tính chất: sau khi close channel thì receive value từ channel luôn luôn không bị block (receive zero value).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
</span></span><span style="display:flex;"><span>	ch <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>(<span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">string</span>)
</span></span><span style="display:flex;"><span>	n <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">10</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; i &lt; n; i<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">go</span> <span style="color:#50fa7b">notify</span>(ch)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#8be9fd;font-style:italic">close</span>(ch)
</span></span><span style="display:flex;"><span>	time.<span style="color:#50fa7b">Sleep</span>(time.Second)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">notify</span>(ch <span style="color:#ff79c6">&lt;-</span><span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">string</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">&lt;-</span>ch
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;receive notify&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>Phản hồi về bí mật - n-to-1 notification</strong></p>
<p>Bí mật của bạn bị chia sẻ ra thì có lẽ nó cũng sẽ nhận được nhiều lời bàn tán. Cách dễ nhất để nhận nhiều lời bàn tán là dùng sync.WaitGroup.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
</span></span><span style="display:flex;"><span>	n <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">10</span>
</span></span><span style="display:flex;"><span>	wg <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>sync.WaitGroup{}
</span></span><span style="display:flex;"><span>	wg.<span style="color:#50fa7b">Add</span>(n)
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; i &lt; n; i<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">go</span> <span style="color:#50fa7b">notify</span>(wg)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	wg.<span style="color:#50fa7b">Wait</span>()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">notify</span>(wg <span style="color:#ff79c6">*</span>sync.WaitGroup) {
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">defer</span> wg.<span style="color:#50fa7b">Done</span>()
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;send notify&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>Sử dụng channels như Mutex Locks</strong></p>
<p>Channel với capacity bằng 1 có thể sử dụng như buffered channel. Tuy nhiên thì dùng cho vui thôi chứ thực tế chả ai dùng channel chỉ để implement lại cái mutex làm gì cả :3</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">type</span> empty <span style="color:#8be9fd;font-style:italic">struct</span>{}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
</span></span><span style="display:flex;"><span>	ch <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>(<span style="color:#8be9fd;font-style:italic">chan</span> empty, <span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	cnt <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>	wg <span style="color:#ff79c6">:=</span> sync.WaitGroup{}
</span></span><span style="display:flex;"><span>	n <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">100</span>
</span></span><span style="display:flex;"><span>	wg.<span style="color:#50fa7b">Add</span>(n)
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; i &lt; n; i<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">defer</span> wg.<span style="color:#50fa7b">Done</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; i &lt; <span style="color:#bd93f9">1000</span>; i<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>				ch <span style="color:#ff79c6">&lt;-</span> empty{}
</span></span><span style="display:flex;"><span>				cnt<span style="color:#ff79c6">++</span>
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&lt;-</span>ch
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	wg.<span style="color:#50fa7b">Wait</span>()
</span></span><span style="display:flex;"><span>	log.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;cnt: &#34;</span>, cnt)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Đoạn code trên dùng channel để đảm bảo synchronize cho biến cnt. Channel phải là buffered channel với cap = 1 để đảm bảo lần lock đầu tiên không bị block. Nếu không sẽ bị deadlock do ông nào cũng đòi khóa mà không ai chịu trả khóa.</p>
<h2 id="sử-dụng-channels-như-counting-semaphores">Sử dụng channels như Counting Semaphores</h2>
<p>Buffered channel có thể sử dụng để implement semaphores. Counting semaphore có thể xem là multi-owner locks. Nếu cap của một channel là N thì nó có thể xem là một cái khóa cho phép N người sử dụng tại một thời điểm. Counting semaphores thường được sử dụng để giới hạn số lượng tài nguyên như số lượng concurrent request tối đa &hellip;</p>
<p>Ví dụ khi bạn vào quán cafe, quán chỉ phục vụ một số lượng chỗ ngồi nhất định, hết chỗ thì &hellip; mời bạn về. Dĩ nhiên rồi, chả nhẽ bạn lại đứng để uống cafe, mà có khi chỗ còn không có mà đứng ấy chứ. Thế làm sao để thông báo cho khách biết là đã hết chỗ rồi (ví dụ như khách đặt bàn online). Cách đơn giản là bạn phải duy trì một biến để đếm số lượng khách trong quán.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">type</span> Seat <span style="color:#8be9fd">int</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">type</span> Bar <span style="color:#8be9fd;font-style:italic">chan</span> Seat
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> (bar Bar) <span style="color:#50fa7b">ServeCustomer</span>(c <span style="color:#8be9fd">int</span>) {
</span></span><span style="display:flex;"><span>	log.<span style="color:#50fa7b">Print</span>(<span style="color:#f1fa8c">&#34;customer#&#34;</span>, c, <span style="color:#f1fa8c">&#34; enters the bar&#34;</span>)
</span></span><span style="display:flex;"><span>	seat <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&lt;-</span>bar <span style="color:#6272a4">// receive value from bar
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	log.<span style="color:#50fa7b">Print</span>(<span style="color:#f1fa8c">&#34;++ customer#&#34;</span>, c, <span style="color:#f1fa8c">&#34;drinks at seat#&#34;</span>, seat)
</span></span><span style="display:flex;"><span>	time.<span style="color:#50fa7b">Sleep</span>(time.Second <span style="color:#ff79c6">*</span> time.<span style="color:#50fa7b">Duration</span>(<span style="color:#bd93f9">10</span><span style="color:#ff79c6">+</span>rand.<span style="color:#50fa7b">Intn</span>(<span style="color:#bd93f9">6</span>)))
</span></span><span style="display:flex;"><span>	log.<span style="color:#50fa7b">Print</span>(<span style="color:#f1fa8c">&#34;-- customer#&#34;</span>, c, <span style="color:#f1fa8c">&#34; free seat#&#34;</span>, seat)
</span></span><span style="display:flex;"><span>	bar <span style="color:#ff79c6">&lt;-</span> seat <span style="color:#6272a4">// release
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
</span></span><span style="display:flex;"><span>	rand.<span style="color:#50fa7b">Seed</span>(time.<span style="color:#50fa7b">Now</span>().<span style="color:#50fa7b">UnixNano</span>())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	bar24x7 <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>(Bar, <span style="color:#bd93f9">10</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> seatId <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; seatId &lt; <span style="color:#8be9fd;font-style:italic">cap</span>(bar24x7); seatId<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>		bar24x7 <span style="color:#ff79c6">&lt;-</span> <span style="color:#50fa7b">Seat</span>(seatId)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> customerId <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; ; customerId<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>		log.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;num goroutine: &#34;</span>, runtime.<span style="color:#50fa7b">NumGoroutine</span>())
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">go</span> bar24x7.<span style="color:#50fa7b">ServeCustomer</span>(customerId)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Đoạn code trên đảm bảo chỉ có nhiều nhất 10 người được phục vụ tại một thời điểm. Mặc dù chỉ có nhiều nhất 10 người được phục vụ tại một thời điểm, tuy nhiên có nhiều hơn 10 customers ở trong hàng đợi để chờ phục vụ (&gt; 10 goroutines), càng lâu thì số lượng goroutine này càng lớn. Từ đó sẽ bị tồn đọng và không bao giờ xử lý hết. Do tốc độ tạo mới nhiều hơn tốc độ consume.</p>
<p>Vậy làm sao để giới hạn số lượng goroutine có thể tạo ra? Ý tưởng là dùng một buffered channel với cap là số lượng channel lớn nhất có thể tồn tại tại một thời điểm.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">type</span> Seat <span style="color:#8be9fd">int</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">type</span> Bar <span style="color:#8be9fd;font-style:italic">chan</span> Seat
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> (bar Bar) <span style="color:#50fa7b">ServeCustomer</span>(c <span style="color:#8be9fd">int</span>, seat Seat) {
</span></span><span style="display:flex;"><span>	log.<span style="color:#50fa7b">Print</span>(<span style="color:#f1fa8c">&#34;++ customer#&#34;</span>, c, <span style="color:#f1fa8c">&#34;drinks at seat#&#34;</span>, seat)
</span></span><span style="display:flex;"><span>	time.<span style="color:#50fa7b">Sleep</span>(time.Second <span style="color:#ff79c6">*</span> time.<span style="color:#50fa7b">Duration</span>(<span style="color:#bd93f9">2</span><span style="color:#ff79c6">+</span>rand.<span style="color:#50fa7b">Intn</span>(<span style="color:#bd93f9">6</span>)))
</span></span><span style="display:flex;"><span>	log.<span style="color:#50fa7b">Print</span>(<span style="color:#f1fa8c">&#34;-- customer#&#34;</span>, c, <span style="color:#f1fa8c">&#34; free seat#&#34;</span>, seat)
</span></span><span style="display:flex;"><span>	bar <span style="color:#ff79c6">&lt;-</span> seat <span style="color:#6272a4">// free seat and leave the bar
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
</span></span><span style="display:flex;"><span>	rand.<span style="color:#50fa7b">Seed</span>(time.<span style="color:#50fa7b">Now</span>().<span style="color:#50fa7b">UnixNano</span>())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	bar24x7 <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>(Bar, <span style="color:#bd93f9">10</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> seatId <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; seatId &lt; <span style="color:#8be9fd;font-style:italic">cap</span>(bar24x7); seatId<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>		bar24x7 <span style="color:#ff79c6">&lt;-</span> <span style="color:#50fa7b">Seat</span>(seatId)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> customerId <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; ; customerId<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>		log.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;num goroutine: &#34;</span>, runtime.<span style="color:#50fa7b">NumGoroutine</span>())
</span></span><span style="display:flex;"><span>		<span style="color:#6272a4">// Need a seed to serve next customer
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		seat <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&lt;-</span>bar24x7
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">go</span> bar24x7.<span style="color:#50fa7b">ServeCustomer</span>(customerId, seat)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Đoạn chương trình trên chỉ đảm bảo được có 10 goroutines tồn tại đồng thời. Tuy nhiên cần tạo rất nhiều goroutines trong quá trình hoạt động (mỗi khi free seat thì lại cần tạo một goroutine mới để xử lý).</p>
<p>Để tối ưu hơn, cần viết một chương trình đảm bảo chỉ có tối đa 10 goroutines tồn tại đồng thời và tối đa 10 goroutines được tạo ra. Đoạn code dưới đây thực hiện yêu cầu này.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
</span></span><span style="display:flex;"><span>	rand.<span style="color:#50fa7b">Seed</span>(time.<span style="color:#50fa7b">Now</span>().<span style="color:#50fa7b">UnixNano</span>())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	maxServe <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">10</span>
</span></span><span style="display:flex;"><span>	consumers <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>(<span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">int</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; i &lt; maxServe; i<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">go</span> <span style="color:#50fa7b">serveCustomer</span>(consumers)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; ; i<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>		log.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;num goroutines:&#34;</span>, runtime.<span style="color:#50fa7b">NumGoroutine</span>())
</span></span><span style="display:flex;"><span>		consumers <span style="color:#ff79c6">&lt;-</span> i
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">serveCustomer</span>(consumers <span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">int</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> consumer <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> consumers {
</span></span><span style="display:flex;"><span>		log.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;++ customer#&#34;</span>, consumer, <span style="color:#f1fa8c">&#34;drinks at the bar&#34;</span>)
</span></span><span style="display:flex;"><span>		time.<span style="color:#50fa7b">Sleep</span>(time.Second <span style="color:#ff79c6">*</span> time.<span style="color:#50fa7b">Duration</span>(<span style="color:#bd93f9">2</span><span style="color:#ff79c6">+</span>rand.<span style="color:#50fa7b">Intn</span>(<span style="color:#bd93f9">6</span>)))
</span></span><span style="display:flex;"><span>		log.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;-- customer#&#34;</span>, consumer, <span style="color:#f1fa8c">&#34;leaves the bar&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="channel-encapsulated-in-channel">Channel Encapsulated in Channel</h2>
<h2 id="try-send-và-try-receive-đến-channel">Try-Send và Try-Receive đến channel</h2>
<p>Khi sử dụng select block với nhánh default và chỉ một nhánh case được gọi là try-send hoặc try-receive (tùy vào nhánh case triển khai ra sao). Try-send và try-receive không bao giờ block.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#8be9fd;font-style:italic">type</span> Book <span style="color:#8be9fd;font-style:italic">struct</span>{ id <span style="color:#8be9fd">int</span> }
</span></span><span style="display:flex;"><span>	bookshelf <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>(<span style="color:#8be9fd;font-style:italic">chan</span> Book, <span style="color:#bd93f9">3</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; i &lt; <span style="color:#8be9fd;font-style:italic">cap</span>(bookshelf)<span style="color:#ff79c6">*</span><span style="color:#bd93f9">2</span>; i<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">select</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">case</span> bookshelf <span style="color:#ff79c6">&lt;-</span> Book{id: i}:
</span></span><span style="display:flex;"><span>			fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;succeeded to put book&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">default</span>:
</span></span><span style="display:flex;"><span>			fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;failed to put book&#34;</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; i &lt; <span style="color:#8be9fd;font-style:italic">cap</span>(bookshelf)<span style="color:#ff79c6">*</span><span style="color:#bd93f9">2</span>; i<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">select</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">case</span> book <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&lt;-</span>bookshelf:
</span></span><span style="display:flex;"><span>			fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;succeeded to get book&#34;</span>, book.id)
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">default</span>:
</span></span><span style="display:flex;"><span>			fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;failed to get book&#34;</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>Check if a channel is closed without blocking the current goroutine</strong></p>
<p>Nếu có thể chắc chắn rằng không có values nào gửi đến channel nữa thì ta có thể sử dụng đoạn code sau (concurrently and safely) để kiểm tra xem một channel đã close hay chưa mà không cần block goroutine hiện tại.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">isClose</span>(c <span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">int</span>) <span style="color:#8be9fd">bool</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">select</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">case</span> _, ok <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&lt;-</span>c:
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">return</span> ok
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">default</span>:
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>Peak/burst limiting</strong></p>
<h2 id="các-cách-khác-để-implement-first-response-win">Các cách khác để implement first-response win</h2>
<p>Ta có thể sử dụng select mechanism (try-send) với buffered channel có capacity bằng 1 (ít nhất 1) để implement first-response-win.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
</span></span><span style="display:flex;"><span>	rand.<span style="color:#50fa7b">Seed</span>(time.<span style="color:#50fa7b">Now</span>().<span style="color:#50fa7b">UnixNano</span>())
</span></span><span style="display:flex;"><span>	c <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>(<span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">int</span>, <span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; i &lt; <span style="color:#bd93f9">5</span>; i<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">go</span> <span style="color:#50fa7b">source</span>(c)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	rnd <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&lt;-</span>c <span style="color:#6272a4">// only the first response win
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	fmt.<span style="color:#50fa7b">Println</span>(rnd)
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">select</span> {}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">source</span>(c <span style="color:#8be9fd;font-style:italic">chan</span><span style="color:#ff79c6">&lt;-</span> <span style="color:#8be9fd">int</span>) {
</span></span><span style="display:flex;"><span>	now <span style="color:#ff79c6">:=</span> time.<span style="color:#50fa7b">Now</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">defer</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
</span></span><span style="display:flex;"><span>		log.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;end call to source after:&#34;</span>, time.<span style="color:#50fa7b">Since</span>(now))
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;call to source&#34;</span>)
</span></span><span style="display:flex;"><span>	ra, rb <span style="color:#ff79c6">:=</span> rand.<span style="color:#50fa7b">Int</span>(), rand.<span style="color:#50fa7b">Intn</span>(<span style="color:#bd93f9">3</span>)<span style="color:#ff79c6">+</span><span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// Sleep 1s, 2s, 3s
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	time.<span style="color:#50fa7b">Sleep</span>(time.<span style="color:#50fa7b">Duration</span>(rb) <span style="color:#ff79c6">*</span> time.Second)
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// try send
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">select</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">case</span> c <span style="color:#ff79c6">&lt;-</span> ra:
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">default</span>:
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Phiên bản trên kết quả thì đúng nhưng sử dụng tài nguyên là thừa thãi. Do khi đã có first-response rồi thì không cần phải tiếp tục thực thi việc gọi đến source nữa.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
</span></span><span style="display:flex;"><span>	ctx, cancel <span style="color:#ff79c6">:=</span> context.<span style="color:#50fa7b">WithCancel</span>(context.<span style="color:#50fa7b">Background</span>())
</span></span><span style="display:flex;"><span>	c <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>(<span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">int</span>, <span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; i &lt; <span style="color:#bd93f9">5</span>; i<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">go</span> <span style="color:#50fa7b">source</span>(ctx, c)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	rnd <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&lt;-</span>c <span style="color:#6272a4">// only the first response win
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">cancel</span>()
</span></span><span style="display:flex;"><span>	log.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;winner: &#34;</span>, rnd)
</span></span><span style="display:flex;"><span>	time.<span style="color:#50fa7b">Sleep</span>(time.Second <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">5</span>)
</span></span><span style="display:flex;"><span>	fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;number of goroutines:&#34;</span>, runtime.<span style="color:#50fa7b">NumGoroutine</span>())
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">source</span>(ctx context.Context, c <span style="color:#8be9fd;font-style:italic">chan</span><span style="color:#ff79c6">&lt;-</span> <span style="color:#8be9fd">int</span>) {
</span></span><span style="display:flex;"><span>	now <span style="color:#ff79c6">:=</span> time.<span style="color:#50fa7b">Now</span>()
</span></span><span style="display:flex;"><span>	fn <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">func</span>(ctx context.Context) <span style="color:#ff79c6">&lt;-</span><span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">int</span> {
</span></span><span style="display:flex;"><span>		rand.<span style="color:#50fa7b">Seed</span>(time.<span style="color:#50fa7b">Now</span>().<span style="color:#50fa7b">UnixNano</span>())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;call to source&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#6272a4">// try-send
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		ch <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>(<span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">int</span>, <span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		ra, rb <span style="color:#ff79c6">:=</span> rand.<span style="color:#50fa7b">Int</span>(), rand.<span style="color:#50fa7b">Intn</span>(<span style="color:#bd93f9">3</span>)<span style="color:#ff79c6">+</span><span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">select</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#6272a4">// simulate work load, we don&#39;t need to call when context is canceled
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		<span style="color:#ff79c6">case</span> <span style="color:#ff79c6">&lt;-</span>time.<span style="color:#50fa7b">After</span>(time.<span style="color:#50fa7b">Duration</span>(rb) <span style="color:#ff79c6">*</span> time.Second):
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">defer</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
</span></span><span style="display:flex;"><span>				log.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;end call to source after:&#34;</span>, time.<span style="color:#50fa7b">Since</span>(now))
</span></span><span style="display:flex;"><span>			}()
</span></span><span style="display:flex;"><span>			ch <span style="color:#ff79c6">&lt;-</span> ra
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">case</span> <span style="color:#ff79c6">&lt;-</span>ctx.<span style="color:#50fa7b">Done</span>():
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">return</span> ch
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">select</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">case</span> <span style="color:#ff79c6">&lt;-</span>ctx.<span style="color:#50fa7b">Done</span>():
</span></span><span style="display:flex;"><span>		log.<span style="color:#50fa7b">Println</span>(ctx.<span style="color:#50fa7b">Err</span>())
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">case</span> v <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&lt;-</span><span style="color:#50fa7b">fn</span>(ctx):
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">select</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">case</span> c <span style="color:#ff79c6">&lt;-</span> v:
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">default</span>:
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="rate-limiting">Rate Limiting</h2>
<p>We can also use try-send to do rate limiting . In practice, rate-limit is often to avoid quota exceeding and resource exhaustion.</p>
<h2 id="fan-in">Fan-in</h2>
<p>Bạn cân viết một chương trình đi crawl data từ một source sau đó in ra console.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
</span></span><span style="display:flex;"><span>	rand.<span style="color:#50fa7b">Seed</span>(time.<span style="color:#50fa7b">Now</span>().<span style="color:#50fa7b">UnixNano</span>())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	c <span style="color:#ff79c6">:=</span> <span style="color:#50fa7b">crawl</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// forward to another source
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; i &lt; <span style="color:#bd93f9">5</span>; i<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>		log.<span style="color:#50fa7b">Println</span>(<span style="color:#ff79c6">&lt;-</span>c)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">crawl</span>() <span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">string</span> {
</span></span><span style="display:flex;"><span>	c <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>(<span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">string</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; ; i<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>			c <span style="color:#ff79c6">&lt;-</span> fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;crawl %d&#34;</span>, i)
</span></span><span style="display:flex;"><span>			time.<span style="color:#50fa7b">Sleep</span>(time.<span style="color:#50fa7b">Duration</span>(rand.<span style="color:#50fa7b">Intn</span>(<span style="color:#bd93f9">1e3</span>)) <span style="color:#ff79c6">*</span> time.Millisecond)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> c
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Yêu cầu mới là bạn phải crawl từ 2 source khác nhau, sau đó in ra console.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
</span></span><span style="display:flex;"><span>	rand.<span style="color:#50fa7b">Seed</span>(time.<span style="color:#50fa7b">Now</span>().<span style="color:#50fa7b">UnixNano</span>())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	c1 <span style="color:#ff79c6">:=</span> <span style="color:#50fa7b">crawl</span>(<span style="color:#f1fa8c">&#34;crawl1&#34;</span>, time.Second)
</span></span><span style="display:flex;"><span>	c2 <span style="color:#ff79c6">:=</span> <span style="color:#50fa7b">crawl</span>(<span style="color:#f1fa8c">&#34;crawl2&#34;</span>, time.Second<span style="color:#ff79c6">*</span><span style="color:#bd93f9">5</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// forward to another source
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; i &lt; <span style="color:#bd93f9">10</span>; i<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>		log.<span style="color:#50fa7b">Println</span>(<span style="color:#ff79c6">&lt;-</span>c1)
</span></span><span style="display:flex;"><span>		log.<span style="color:#50fa7b">Println</span>(<span style="color:#ff79c6">&lt;-</span>c2)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">crawl</span>(id <span style="color:#8be9fd">string</span>, sleepTime time.Duration) <span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">string</span> {
</span></span><span style="display:flex;"><span>	c <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>(<span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">string</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; ; i<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>			c <span style="color:#ff79c6">&lt;-</span> fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;crawl for %s: %d&#34;</span>, id, i)
</span></span><span style="display:flex;"><span>			time.<span style="color:#50fa7b">Sleep</span>(sleepTime)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> c
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Kết quả trả ra là một kết quả tuần tự crawl1,crawl2,crawl1,crawl2&hellip; crawl1 phải đợi crawl2 đi crawl xong thì mới được chạy.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span>2023/04/04 16:35:06 crawl for crawl1: 0
</span></span><span style="display:flex;"><span>2023/04/04 16:35:06 crawl for crawl2: 0
</span></span><span style="display:flex;"><span>2023/04/04 16:35:07 crawl for crawl1: 1
</span></span><span style="display:flex;"><span>2023/04/04 16:35:11 crawl for crawl2: 1
</span></span><span style="display:flex;"><span>2023/04/04 16:35:11 crawl for crawl1: 2
</span></span><span style="display:flex;"><span>2023/04/04 16:35:16 crawl for crawl2: 2
</span></span><span style="display:flex;"><span>2023/04/04 16:35:16 crawl for crawl1: 3
</span></span><span style="display:flex;"><span>2023/04/04 16:35:21 crawl for crawl2: 3
</span></span><span style="display:flex;"><span>2023/04/04 16:35:21 crawl for crawl1: 4
</span></span></code></pre></div><p>Sếp yêu cầu kết quả bạn crawl phải là realtime. Fan-in chính là giải pháp</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
</span></span><span style="display:flex;"><span>	rand.<span style="color:#50fa7b">Seed</span>(time.<span style="color:#50fa7b">Now</span>().<span style="color:#50fa7b">UnixNano</span>())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	c1 <span style="color:#ff79c6">:=</span> <span style="color:#50fa7b">crawl</span>(<span style="color:#f1fa8c">&#34;crawl1&#34;</span>, time.Second)
</span></span><span style="display:flex;"><span>	c2 <span style="color:#ff79c6">:=</span> <span style="color:#50fa7b">crawl</span>(<span style="color:#f1fa8c">&#34;crawl2&#34;</span>, time.Second<span style="color:#ff79c6">*</span><span style="color:#bd93f9">5</span>)
</span></span><span style="display:flex;"><span>	c <span style="color:#ff79c6">:=</span> <span style="color:#50fa7b">fanIn</span>(c1, c2)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// forward to another source
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; i &lt; <span style="color:#bd93f9">10</span>; i<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>		log.<span style="color:#50fa7b">Println</span>(<span style="color:#ff79c6">&lt;-</span>c)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">crawl</span>(id <span style="color:#8be9fd">string</span>, sleepTime time.Duration) <span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">string</span> {
</span></span><span style="display:flex;"><span>	c <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>(<span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">string</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; ; i<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>			c <span style="color:#ff79c6">&lt;-</span> fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;crawl for %s: %d&#34;</span>, id, i)
</span></span><span style="display:flex;"><span>			time.<span style="color:#50fa7b">Sleep</span>(sleepTime)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> c
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">fanIn</span>(c <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">string</span>) <span style="color:#ff79c6">&lt;-</span><span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">string</span> {
</span></span><span style="display:flex;"><span>	fi <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>(<span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">string</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> _, v <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> c {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>(v <span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">string</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> v {
</span></span><span style="display:flex;"><span>				fi <span style="color:#ff79c6">&lt;-</span> i
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}(v)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> fi
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Kết quả đa số kết quả sẽ từ crawl1 vì crawl1 chạy nhanh hơn.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span>2023/04/04 16:35:57 crawl for crawl1: 0
</span></span><span style="display:flex;"><span>2023/04/04 16:35:57 crawl for crawl2: 0
</span></span><span style="display:flex;"><span>2023/04/04 16:35:58 crawl for crawl1: 1
</span></span><span style="display:flex;"><span>2023/04/04 16:35:59 crawl for crawl1: 2
</span></span><span style="display:flex;"><span>2023/04/04 16:36:00 crawl for crawl1: 3
</span></span><span style="display:flex;"><span>2023/04/04 16:36:01 crawl for crawl1: 4
</span></span><span style="display:flex;"><span>2023/04/04 16:36:02 crawl for crawl2: 1
</span></span><span style="display:flex;"><span>2023/04/04 16:36:02 crawl for crawl1: 5
</span></span><span style="display:flex;"><span>2023/04/04 16:36:03 crawl for crawl1: 6
</span></span><span style="display:flex;"><span>2023/04/04 16:36:04 crawl for crawl1: 7
</span></span></code></pre></div><p>Để sử dụng fan-in, luồng dữ liệu phải không phụ thuộc lẫn nhau</p>
<p>Đoạn code bên trên chưa graceful close channel và có goroutine leak. Chú ý phần này.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
</span></span><span style="display:flex;"><span>	rand.<span style="color:#50fa7b">Seed</span>(time.<span style="color:#50fa7b">Now</span>().<span style="color:#50fa7b">UnixNano</span>())
</span></span><span style="display:flex;"><span>	ctx, cancel <span style="color:#ff79c6">:=</span> context.<span style="color:#50fa7b">WithCancel</span>(context.<span style="color:#50fa7b">Background</span>())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	c1 <span style="color:#ff79c6">:=</span> <span style="color:#50fa7b">crawl</span>(ctx, <span style="color:#f1fa8c">&#34;crawl1&#34;</span>, time.Millisecond<span style="color:#ff79c6">*</span><span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>	c2 <span style="color:#ff79c6">:=</span> <span style="color:#50fa7b">crawl</span>(ctx, <span style="color:#f1fa8c">&#34;crawl2&#34;</span>, time.Millisecond<span style="color:#ff79c6">*</span><span style="color:#bd93f9">2</span>)
</span></span><span style="display:flex;"><span>	c <span style="color:#ff79c6">:=</span> <span style="color:#50fa7b">fanIn</span>(ctx, c1, c2)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// forward to another source
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; i &lt; <span style="color:#bd93f9">2</span>; i<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>		log.<span style="color:#50fa7b">Println</span>(<span style="color:#ff79c6">&lt;-</span>c)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">cancel</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// _ = cancel
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	time.<span style="color:#50fa7b">Sleep</span>(time.Second <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>	log.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;num goroutines:&#34;</span>, runtime.<span style="color:#50fa7b">NumGoroutine</span>())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">crawl</span>(ctx context.Context, id <span style="color:#8be9fd">string</span>, sleepTime time.Duration) <span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">string</span> {
</span></span><span style="display:flex;"><span>	c <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>(<span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">string</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">defer</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
</span></span><span style="display:flex;"><span>			log.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;exit crawl goroutine&#34;</span>)
</span></span><span style="display:flex;"><span>		}()
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">for</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">select</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">case</span> c <span style="color:#ff79c6">&lt;-</span> fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;crawl for %s&#34;</span>, id):
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">case</span> <span style="color:#ff79c6">&lt;-</span>ctx.<span style="color:#50fa7b">Done</span>():
</span></span><span style="display:flex;"><span>				log.<span style="color:#50fa7b">Printf</span>(<span style="color:#f1fa8c">&#34;close %s\n&#34;</span>, id)
</span></span><span style="display:flex;"><span>				<span style="color:#8be9fd;font-style:italic">close</span>(c)
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> c
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">fanIn</span>(ctx context.Context, c <span style="color:#ff79c6">...</span><span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">string</span>) <span style="color:#ff79c6">&lt;-</span><span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">string</span> {
</span></span><span style="display:flex;"><span>	fi <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>(<span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">string</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	wg <span style="color:#ff79c6">:=</span> sync.WaitGroup{}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> _, v <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> c {
</span></span><span style="display:flex;"><span>		wg.<span style="color:#50fa7b">Add</span>(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>(v <span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">string</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">defer</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
</span></span><span style="display:flex;"><span>				wg.<span style="color:#50fa7b">Done</span>()
</span></span><span style="display:flex;"><span>				log.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;exit fanIn goroutine&#34;</span>)
</span></span><span style="display:flex;"><span>			}()
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> v {
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">select</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">case</span> fi <span style="color:#ff79c6">&lt;-</span> i:
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">case</span> <span style="color:#ff79c6">&lt;-</span>ctx.<span style="color:#50fa7b">Done</span>():
</span></span><span style="display:flex;"><span>					<span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}(v)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">defer</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
</span></span><span style="display:flex;"><span>			log.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;exit wg goroutine&#34;</span>)
</span></span><span style="display:flex;"><span>		}()
</span></span><span style="display:flex;"><span>		wg.<span style="color:#50fa7b">Wait</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#8be9fd;font-style:italic">close</span>(fi)
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> fi
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></div>
</article>


    
    
        
        
        
            
                
                
        
            
                
                
        
            
                
                
        
    





    
    
        
        <div class="relatedArticlesContainer">
            <hr />
            <h2>More posts like this</h2>
            <div class="postlist ">
                <article class="card postlistitem">
    <div>
        <h2>
            <a href="https://idev-blog.web.app/posts/programming-language-channel-in-golang/">Channel in Golang</a>
        </h2>
        <p class="date">
            <span title='Date'> </span>
    2022-11-05


                | 
                <span title='Tags'> </span>
                
                    <a href="/tags/basic">#basic</a>
                
                    <a href="/tags/golang">#golang</a>
                
            
        </p>
        
            
        
        
            <div class="articlePreview">
                <p>
                    
                        Channel is an important built-in feature in Go. It is one of the features makes Go unique. Channel makes concurrent programming convenient, fun and lowers the difficulties of concurrent programming. Channel mainly acts as a concurrency synchronization technique. To understand channels better, the internal structure of channels and some implementation details by the standard Go compiler/runtime are also simply described.
                    
                </p>
                
            </div>
        
    </div>
</article>

            </div>
        </div>
    


                    </main><footer>

<p><small>
        2023 &copy; Tran Duc Ngoc
    </small></p>
    <p><small>
        
    </small></p>
</footer>
</div>
            </div>
        </div>


</body>
</html>
